version: '3.8'

services:
  # Redpanda broker 1
  redpanda-1:
    image: docker.redpanda.com/vectorized/redpanda:v23.3.3
    container_name: redpanda-1
    command:
      - redpanda
      - start
      - --kafka-addr internal://0.0.0.0:9092,external://0.0.0.0:19092
      - --advertise-kafka-addr internal://redpanda-1:9092,external://localhost:19092
      - --pandaproxy-addr internal://0.0.0.0:8082,external://0.0.0.0:18082
      - --advertise-pandaproxy-addr internal://redpanda-1:8082,external://localhost:18082
      - --schema-registry-addr internal://0.0.0.0:8081,external://0.0.0.0:18081
      - --rpc-addr redpanda-1:33145
      - --advertise-rpc-addr redpanda-1:33145
      - --mode dev-container
      - --smp 1
      - --default-log-level=info
      - --memory 1G
    ports:
      - 18081:18081  # Schema Registry
      - 18082:18082  # Pandaproxy
      - 19092:19092  # Kafka
      - 19644:9644   # Admin API
    volumes:
      - redpanda-1:/var/lib/redpanda/data
    networks:
      - redpanda-network
    healthcheck:
      test: ["CMD-SHELL", "rpk cluster health | grep -q 'Healthy:.*true' || exit 1"]
      interval: 15s
      timeout: 3s
      retries: 5
      start_period: 5s

  # Redpanda broker 2
  redpanda-2:
    image: docker.redpanda.com/vectorized/redpanda:v23.3.3
    container_name: redpanda-2
    command:
      - redpanda
      - start
      - --kafka-addr internal://0.0.0.0:9092,external://0.0.0.0:29092
      - --advertise-kafka-addr internal://redpanda-2:9092,external://localhost:29092
      - --pandaproxy-addr internal://0.0.0.0:8082,external://0.0.0.0:28082
      - --advertise-pandaproxy-addr internal://redpanda-2:8082,external://localhost:28082
      - --schema-registry-addr internal://0.0.0.0:8081,external://0.0.0.0:28081
      - --rpc-addr redpanda-2:33145
      - --advertise-rpc-addr redpanda-2:33145
      - --mode dev-container
      - --smp 1
      - --seeds redpanda-1:33145
      - --default-log-level=info
      - --memory 1G
    ports:
      - 28081:28081
      - 28082:28082
      - 29092:29092
      - 29644:9644
    volumes:
      - redpanda-2:/var/lib/redpanda/data
    networks:
      - redpanda-network
    depends_on:
      redpanda-1:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "rpk cluster health | grep -q 'Healthy:.*true' || exit 1"]
      interval: 15s
      timeout: 3s
      retries: 5
      start_period: 5s

  # Redpanda broker 3
  redpanda-3:
    image: docker.redpanda.com/vectorized/redpanda:v23.3.3
    container_name: redpanda-3
    command:
      - redpanda
      - start
      - --kafka-addr internal://0.0.0.0:9092,external://0.0.0.0:39092
      - --advertise-kafka-addr internal://redpanda-3:9092,external://localhost:39092
      - --pandaproxy-addr internal://0.0.0.0:8082,external://0.0.0.0:38082
      - --advertise-pandaproxy-addr internal://redpanda-3:8082,external://localhost:38082
      - --schema-registry-addr internal://0.0.0.0:8081,external://0.0.0.0:38081
      - --rpc-addr redpanda-3:33145
      - --advertise-rpc-addr redpanda-3:33145
      - --mode dev-container
      - --smp 1
      - --seeds redpanda-1:33145
      - --default-log-level=info
      - --memory 1G
    ports:
      - 38081:38081
      - 38082:38082
      - 39092:39092
      - 39644:9644
    volumes:
      - redpanda-3:/var/lib/redpanda/data
    networks:
      - redpanda-network
    depends_on:
      redpanda-1:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "rpk cluster health | grep -q 'Healthy:.*true' || exit 1"]
      interval: 15s
      timeout: 3s
      retries: 5
      start_period: 5s

  # Redpanda Console for cluster management
  console:
    image: docker.redpanda.com/vectorized/console:v2.3.8
    container_name: redpanda-console
    entrypoint: /bin/sh
    command: -c 'echo "$$CONSOLE_CONFIG_FILE" > /tmp/config.yml; /app/console'
    environment:
      CONFIG_FILEPATH: /tmp/config.yml
      CONSOLE_CONFIG_FILE: |
        kafka:
          brokers: ["redpanda-1:9092", "redpanda-2:9092", "redpanda-3:9092"]
          schemaRegistry:
            enabled: true
            urls: ["http://redpanda-1:8081"]
        redpanda:
          adminApi:
            enabled: true
            urls: ["http://redpanda-1:9644", "http://redpanda-2:9644", "http://redpanda-3:9644"]
    ports:
      - 8080:8080
    networks:
      - redpanda-network
    depends_on:
      - redpanda-1
      - redpanda-2
      - redpanda-3

  # PostgreSQL for state management
  postgres:
    image: postgres:15-alpine
    container_name: streaming-postgres
    environment:
      POSTGRES_USER: streaming
      POSTGRES_PASSWORD: streaming_pass
      POSTGRES_DB: streaming_state
    ports:
      - 5432:5432
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./init.sql:/docker-entrypoint-initdb.d/init.sql
    networks:
      - redpanda-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U streaming"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis for feature store and caching
  redis:
    image: redis:7-alpine
    container_name: streaming-redis
    command: redis-server --appendonly yes
    ports:
      - 6379:6379
    volumes:
      - redis-data:/data
    networks:
      - redpanda-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5

  # Prometheus for metrics
  prometheus:
    image: prom/prometheus:latest
    container_name: streaming-prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/etc/prometheus/console_libraries'
      - '--web.console.templates=/etc/prometheus/consoles'
      - '--web.enable-lifecycle'
    ports:
      - 9090:9090
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus-data:/prometheus
    networks:
      - redpanda-network

  # Grafana for visualization
  grafana:
    image: grafana/grafana:latest
    container_name: streaming-grafana
    ports:
      - 3000:3000
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=admin
      - GF_INSTALL_PLUGINS=redis-datasource
    volumes:
      - grafana-data:/var/lib/grafana
      - ./grafana-dashboards:/etc/grafana/provisioning/dashboards
    networks:
      - redpanda-network
    depends_on:
      - prometheus

volumes:
  redpanda-1:
  redpanda-2:
  redpanda-3:
  postgres-data:
  redis-data:
  prometheus-data:
  grafana-data:

networks:
  redpanda-network:
    driver: bridge
